<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Disposable Email</title>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #0f0f10;
            --card: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.08);
            --text: #e7e7e7;
            --accent: #4da6ff;
            --accent-glow: 0 0 12px #4da6ff88;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: var(--bg);
            color: var(--text);
            padding: 25px;
        }

        h1 {
            text-align: center;
            font-size: 30px;
            margin-bottom: 25px;
            font-weight: 600;
            color: var(--accent);
            text-shadow: var(--accent-glow);
        }

        .container {
            max-width: 750px;
            margin: auto;
        }

        button {
            background: var(--accent);
            border: none;
            padding: 10px 16px;
            margin-right: 10px;
            margin-bottom: 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: #fff;
            transition: 0.2s;
            box-shadow: var(--accent-glow);
        }

        button:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }

        .email-box {
            background: var(--card);
            padding: 18px;
            border-radius: 10px;
            border: 1px solid var(--border);
            margin-bottom: 25px;
            backdrop-filter: blur(8px);
        }

        .email-card {
            background: var(--card);
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
            backdrop-filter: blur(8px);
            transition: 0.25s;
        }

        .email-card:hover {
            border-color: var(--accent);
            transform: translateY(-3px);
            box-shadow: var(--accent-glow);
        }

        #currentEmail {
            font-size: 18px;
            margin: 7px 0;
            color: var(--accent);
            font-weight: 600;
        }

        .empty-msg {
            text-align: center;
            padding: 35px 0;
            color: #777;
        }
    </style>
</head>

<body>
<div class="container">
    <h1>Disposable Email</h1>

    <button id="newEmailBtn">Generate Email</button>
    <button id="copyBtn">Copy</button>
    <button id="checkInboxBtn">Check Inbox</button>

    <div class="email-box">
        <h3>Your Email Address</h3>
        <p id="currentEmail">(none)</p>
    </div>

    <h2>Inbox</h2>
    <div id="emails"></div>
</div>

<script>
let currentEmail = null;
let ws = null;

document.getElementById("newEmailBtn").onclick = async () => {
    const res = await fetch("/api/generate-email");
    const data = await res.json();
    currentEmail = data.email;

    document.getElementById("currentEmail").innerText = currentEmail;
    connectWebSocket();
    loadInbox();
};

// Copy email
document.getElementById("copyBtn").onclick = () => {
    if (!currentEmail) return;
    navigator.clipboard.writeText(currentEmail);
    alert("Copied!");
};

// Check inbox
document.getElementById("checkInboxBtn").onclick = async () => {
    loadInbox();
};

// Load inbox
async function loadInbox() {
    if (!currentEmail) return;

    const res = await fetch(`/api/inbox?email=${currentEmail}`);
    const messages = await res.json();

    if (messages.length === 0) {
        document.getElementById("emails").innerHTML =
            `<p class="empty-msg">No messages yet...</p>`;
        return;
    }

    renderMessages(messages);
}

// WebSocket for live email
function connectWebSocket() {
    if (ws) ws.close();
   ws = new WebSocket(`wss://dispo-4vdk.onrender.com/?email=${currentEmail}`);


    ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        prependMessage(msg);
    };
}

function renderMessages(list) {
    document.getElementById("emails").innerHTML =
        list.map(m => formatMessage(m)).join("");
}

function prependMessage(m) {
    const div = document.createElement("div");
    div.innerHTML = formatMessage(m);
    document.getElementById("emails").prepend(div.firstElementChild);
}

function formatMessage(m) {
    return `
        <div class="email-card">
            <strong>From:</strong> ${m.from}<br>
            <strong>Subject:</strong> ${m.subject}<br><br>
            <div>${m.body}</div>
            <br>
            <small>${new Date(m.time).toLocaleString()}</small>
        </div>
    `;
}
</script>
</body>
</html>
